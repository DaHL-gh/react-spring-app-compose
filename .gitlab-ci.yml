stages:
  - build

react-build:
  stage: build
  image: quay.io/buildah/stable
  variables:
    BUILDAH_ISOLATION: chroot
    STORAGE_DRIVER: vfs
    DOCKER_TAG: "dahl8dh/hobbie-react-frontend:v1"
    DOCKERFILE_PATH: "./react-frontend/"
  script:
    - buildah login -u "$DOCKERHUB_USER" -p "$DOCKERHUB_PASSWORD" docker.io
    - buildah bud
      --layers
      --cache-from $CI_REGISTRY_IMAGE/cache
      --cache-to $CI_REGISTRY_IMAGE/cache,mode=max
      -t $DOCKER_TAG
      $DOCKERFILE_PATH
    - buildah push $DOCKER_TAG docker://docker.io/$DOCKER_TAG

spring-build:
  stage: build
  image: quay.io/buildah/stable
  variables:
    BUILDAH_ISOLATION: chroot
    STORAGE_DRIVER: vfs
    DOCKER_TAG: "dahl8dh/hobbie-spring-backend:v1"
    DOCKERFILE_PATH: "./spring-backend/"
  script:
    - buildah login -u "$DOCKERHUB_USER" -p "$DOCKERHUB_PASSWORD" docker.io
    - buildah bud
      --layers
      --cache-from $CI_REGISTRY_IMAGE/cache
      --cache-to $CI_REGISTRY_IMAGE/cache
      -t $DOCKER_TAG
      $DOCKERFILE_PATH
    - buildah push $DOCKER_TAG docker://$DOCKER_TAG
